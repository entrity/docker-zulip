<IfModule mod_ssl.c>
  <VirtualHost *:443>
    ServerName famchat.markhamanderson.com
    ServerAlias famchat.duckofdoom.com

    SSLCertificateFile /etc/letsencrypt/live/famchat.markhamanderson.com-0001/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/famchat.markhamanderson.com-0001/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    Include /etc/apache2/sites-available/zulip-shared-snippet.conf

    RequestHeader set Host famchat.duckofdoom.com

    RewriteEngine On

    RewriteRule ^/accounts/do_confirm/(.*)$ https://famchat.markhamanderson.com/accounts/do_confirm/$1 [R,L]
    RewriteRule ^/accounts/register/(.*)$ https://famchat.markhamanderson.com/accounts/register/$1 [R,L]
    RewriteRule ^/join/(.*)$ https://famchat.markhamanderson.com/join/$1 [R,L]

    # Support file uploads (tus returns a Location header https://.../api/v1/tus/...)
    Header edit Location ^https://famchat.duckofdoom.com/(.*) https://famchat.markhamanderson.com/$1

    # I have to unset these headers first because nginx (from zulip docker) sets them, and setting them in apache sends 2 copies of the header to the client, and only the nginx one is used.
    Header unset Access-Control-Allow-Origin
    Header always set Access-Control-Allow-Origin "https://famchat.markhamanderson.com"
    Header unset Access-Control-Allow-Methods
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, PATCH, OPTIONS, HEAD"
    Header unset Access-Control-Allow-Headers
    # With this, I DO get past CORS errors, but I get a 401. It doesn't actually send any cookies?
    Header always set Access-Control-Allow-Headers "Authorization, Accept, Accept-Encoding, Accept-Language, Connection, Content-Length, Content-Type, Cookie, Host, Origin, Referer, Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site, Sec-GPC, Tus-Resumable, Upload-Offset, User-Agent, sec-ch-ua, sec-ch-ua-mobile, sec-ch-ua-platform, X-Requested-With, Tus-Extension, Tus-Version, Vary, Keep-Alive"
    # Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Tus-Resumable, Tus-Extension, Tus-Version, Vary, Keep-Alive, Upload-Offset, Cookie"
  </VirtualHost>
</IfModule>
