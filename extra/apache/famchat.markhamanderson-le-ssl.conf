<IfModule mod_ssl.c>
  <VirtualHost *:443>
    ServerName famchat.duckofdoom.com
    RewriteEngine On
    # RewriteCond %{REQUEST_URI} ^/$
    # RewriteRule / https://famchat.markhamanderson.com/ [R,L]
    Include /etc/apache2/sites-available/zulip-shared-snippet.conf
    RequestHeader set "X-Forwarded-Proto" expr=%{REQUEST_SCHEME}

    RewriteRule ^/accounts/do_confirm/(.*)$ https://famchat.markhamanderson.com/accounts/do_confirm/$1 [R,L]
    RewriteRule ^/accounts/register/(.*)$ https://famchat.markhamanderson.com/accounts/register/$1 [R,L]
    RewriteRule ^/join/(.*)$ https://famchat.markhamanderson.com/join/$1 [R,L]

    # I have to unset these headers first because nginx (from zulip docker) sets them, and setting them in apache sends 2 copies of the header to the client, and only the nginx one is used.
    Header unset Access-Control-Allow-Origin
    Header always set Access-Control-Allow-Origin "https://famchat.markhamanderson.com"
    Header unset Access-Control-Allow-Methods
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, PATCH, OPTIONS, HEAD"
    Header unset Access-Control-Allow-Headers
    # With this, I DO get past CORS errors, but I get a 401. It doesn't actually send any cookies?
    Header always set Access-Control-Allow-Headers "Authorization, Accept, Accept-Encoding, Accept-Language, Connection, Content-Length, Content-Type, Cookie, Host, Origin, Referer, Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site, Sec-GPC, Tus-Resumable, Upload-Offset, User-Agent, sec-ch-ua, sec-ch-ua-mobile, sec-ch-ua-platform, X-Requested-With, Tus-Extension, Tus-Version, Vary, Keep-Alive"
    # Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Tus-Resumable, Tus-Extension, Tus-Version, Vary, Keep-Alive, Upload-Offset, Cookie"
  </VirtualHost>

  <VirtualHost *:443>
    ServerName famchat.markhamanderson.com
    RewriteEngine On

    RequestHeader set "X-Forwarded-Proto" expr=%{REQUEST_SCHEME}
    RequestHeader set Host famchat.duckofdoom.com

    Include /etc/apache2/sites-available/zulip-shared-snippet.conf
  </VirtualHost>

  <VirtualHost *:80>
      ServerName famchat.markhamanderson.com
      ServerAlias famchat.duckofdoom.com
      RewriteEngine On

      RewriteRule ^ https://famchat.markhamanderson.com%{REQUEST_URI} [R=301,L]
  </VirtualHost>
</IfModule>
